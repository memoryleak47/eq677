from z3 import *

def magmadef_7_0():
    name = "7/0"
    n = 7
    m = dict()
    c = dict()
    m[(0, 0)] = 0; m[(0, 1)] = 1; m[(0, 2)] = 2; m[(0, 3)] = 3; m[(0, 4)] = 4; m[(0, 5)] = 5; m[(0, 6)] = 6; m[(1, 0)] = 4; m[(1, 1)] = 5; m[(1, 2)] = 6; m[(1, 3)] = 0; m[(1, 4)] = 1; m[(1, 5)] = 2; m[(1, 6)] = 3; m[(2, 0)] = 1; m[(2, 1)] = 2; m[(2, 2)] = 3; m[(2, 3)] = 4; m[(2, 4)] = 5; m[(2, 5)] = 6; m[(2, 6)] = 0; m[(3, 0)] = 5; m[(3, 1)] = 6; m[(3, 2)] = 0; m[(3, 3)] = 1; m[(3, 4)] = 2; m[(3, 5)] = 3; m[(3, 6)] = 4; m[(4, 0)] = 2; m[(4, 1)] = 3; m[(4, 2)] = 4; m[(4, 3)] = 5; m[(4, 4)] = 6; m[(4, 5)] = 0; m[(4, 6)] = 1; m[(5, 0)] = 6; m[(5, 1)] = 0; m[(5, 2)] = 1; m[(5, 3)] = 2; m[(5, 4)] = 3; m[(5, 5)] = 4; m[(5, 6)] = 5; m[(6, 0)] = 3; m[(6, 1)] = 4; m[(6, 2)] = 5; m[(6, 3)] = 6; m[(6, 4)] = 0; m[(6, 5)] = 1; m[(6, 6)] = 2;
    c[(0, 0)] = 0; c[(0, 1)] = 1; c[(0, 2)] = 1; c[(0, 3)] = 1; c[(0, 4)] = 1; c[(0, 5)] = 1; c[(0, 6)] = 1; c[(1, 0)] = 2; c[(1, 1)] = 3; c[(1, 2)] = 4; c[(1, 3)] = 5; c[(1, 4)] = 6; c[(1, 5)] = 7; c[(1, 6)] = 8; c[(2, 0)] = 2; c[(2, 1)] = 6; c[(2, 2)] = 3; c[(2, 3)] = 7; c[(2, 4)] = 4; c[(2, 5)] = 8; c[(2, 6)] = 5; c[(3, 0)] = 2; c[(3, 1)] = 7; c[(3, 2)] = 5; c[(3, 3)] = 3; c[(3, 4)] = 8; c[(3, 5)] = 6; c[(3, 6)] = 4; c[(4, 0)] = 2; c[(4, 1)] = 4; c[(4, 2)] = 6; c[(4, 3)] = 8; c[(4, 4)] = 3; c[(4, 5)] = 5; c[(4, 6)] = 7; c[(5, 0)] = 2; c[(5, 1)] = 5; c[(5, 2)] = 8; c[(5, 3)] = 4; c[(5, 4)] = 7; c[(5, 5)] = 3; c[(5, 6)] = 6; c[(6, 0)] = 2; c[(6, 1)] = 8; c[(6, 2)] = 7; c[(6, 3)] = 6; c[(6, 4)] = 5; c[(6, 5)] = 4; c[(6, 6)] = 3;
    t = [(0, 0, 0, 0, ), (1, 2, 6, 1, ), (2, 4, 1, 5, ), (3, 5, 2, 6, ), (4, 8, 4, 7, ), (5, 1, 7, 8, ), (6, 3, 5, 2, ), (7, 6, 8, 3, ), (8, 7, 3, 4, ), ]
    return n, name, m, c, t

def magmadef_7_1():
    name = "7/1"
    n = 7
    m = dict()
    c = dict()
    m[(0, 0)] = 0; m[(0, 1)] = 3; m[(0, 2)] = 6; m[(0, 3)] = 2; m[(0, 4)] = 5; m[(0, 5)] = 1; m[(0, 6)] = 4; m[(1, 0)] = 4; m[(1, 1)] = 0; m[(1, 2)] = 3; m[(1, 3)] = 6; m[(1, 4)] = 2; m[(1, 5)] = 5; m[(1, 6)] = 1; m[(2, 0)] = 1; m[(2, 1)] = 4; m[(2, 2)] = 0; m[(2, 3)] = 3; m[(2, 4)] = 6; m[(2, 5)] = 2; m[(2, 6)] = 5; m[(3, 0)] = 5; m[(3, 1)] = 1; m[(3, 2)] = 4; m[(3, 3)] = 0; m[(3, 4)] = 3; m[(3, 5)] = 6; m[(3, 6)] = 2; m[(4, 0)] = 2; m[(4, 1)] = 5; m[(4, 2)] = 1; m[(4, 3)] = 4; m[(4, 4)] = 0; m[(4, 5)] = 3; m[(4, 6)] = 6; m[(5, 0)] = 6; m[(5, 1)] = 2; m[(5, 2)] = 5; m[(5, 3)] = 1; m[(5, 4)] = 4; m[(5, 5)] = 0; m[(5, 6)] = 3; m[(6, 0)] = 3; m[(6, 1)] = 6; m[(6, 2)] = 2; m[(6, 3)] = 5; m[(6, 4)] = 1; m[(6, 5)] = 4; m[(6, 6)] = 0;
    c[(0, 0)] = 0; c[(0, 1)] = 1; c[(0, 2)] = 1; c[(0, 3)] = 1; c[(0, 4)] = 1; c[(0, 5)] = 1; c[(0, 6)] = 1; c[(1, 0)] = 2; c[(1, 1)] = 3; c[(1, 2)] = 4; c[(1, 3)] = 5; c[(1, 4)] = 6; c[(1, 5)] = 7; c[(1, 6)] = 8; c[(2, 0)] = 2; c[(2, 1)] = 6; c[(2, 2)] = 3; c[(2, 3)] = 7; c[(2, 4)] = 4; c[(2, 5)] = 8; c[(2, 6)] = 5; c[(3, 0)] = 2; c[(3, 1)] = 7; c[(3, 2)] = 5; c[(3, 3)] = 3; c[(3, 4)] = 8; c[(3, 5)] = 6; c[(3, 6)] = 4; c[(4, 0)] = 2; c[(4, 1)] = 4; c[(4, 2)] = 6; c[(4, 3)] = 8; c[(4, 4)] = 3; c[(4, 5)] = 5; c[(4, 6)] = 7; c[(5, 0)] = 2; c[(5, 1)] = 5; c[(5, 2)] = 8; c[(5, 3)] = 4; c[(5, 4)] = 7; c[(5, 5)] = 3; c[(5, 6)] = 6; c[(6, 0)] = 2; c[(6, 1)] = 8; c[(6, 2)] = 7; c[(6, 3)] = 6; c[(6, 4)] = 5; c[(6, 5)] = 4; c[(6, 6)] = 3;
    t = [(0, 0, 0, 0, ), (1, 2, 7, 1, ), (2, 4, 1, 3, ), (3, 1, 5, 8, ), (4, 7, 6, 6, ), (5, 8, 4, 4, ), (6, 6, 3, 2, ), (7, 5, 8, 7, ), (8, 3, 2, 5, ), ]
    return n, name, m, c, t

def magmadef_9_0():
    name = "9/0"
    n = 9
    m = dict()
    c = dict()
    m[(0, 0)] = 0; m[(0, 1)] = 8; m[(0, 2)] = 4; m[(0, 3)] = 7; m[(0, 4)] = 3; m[(0, 5)] = 2; m[(0, 6)] = 5; m[(0, 7)] = 1; m[(0, 8)] = 6; m[(1, 0)] = 1; m[(1, 1)] = 6; m[(1, 2)] = 5; m[(1, 3)] = 8; m[(1, 4)] = 4; m[(1, 5)] = 0; m[(1, 6)] = 3; m[(1, 7)] = 2; m[(1, 8)] = 7; m[(2, 0)] = 2; m[(2, 1)] = 7; m[(2, 2)] = 3; m[(2, 3)] = 6; m[(2, 4)] = 5; m[(2, 5)] = 1; m[(2, 6)] = 4; m[(2, 7)] = 0; m[(2, 8)] = 8; m[(3, 0)] = 3; m[(3, 1)] = 2; m[(3, 2)] = 7; m[(3, 3)] = 1; m[(3, 4)] = 6; m[(3, 5)] = 5; m[(3, 6)] = 8; m[(3, 7)] = 4; m[(3, 8)] = 0; m[(4, 0)] = 4; m[(4, 1)] = 0; m[(4, 2)] = 8; m[(4, 3)] = 2; m[(4, 4)] = 7; m[(4, 5)] = 3; m[(4, 6)] = 6; m[(4, 7)] = 5; m[(4, 8)] = 1; m[(5, 0)] = 5; m[(5, 1)] = 1; m[(5, 2)] = 6; m[(5, 3)] = 0; m[(5, 4)] = 8; m[(5, 5)] = 4; m[(5, 6)] = 7; m[(5, 7)] = 3; m[(5, 8)] = 2; m[(6, 0)] = 6; m[(6, 1)] = 5; m[(6, 2)] = 1; m[(6, 3)] = 4; m[(6, 4)] = 0; m[(6, 5)] = 8; m[(6, 6)] = 2; m[(6, 7)] = 7; m[(6, 8)] = 3; m[(7, 0)] = 7; m[(7, 1)] = 3; m[(7, 2)] = 2; m[(7, 3)] = 5; m[(7, 4)] = 1; m[(7, 5)] = 6; m[(7, 6)] = 0; m[(7, 7)] = 8; m[(7, 8)] = 4; m[(8, 0)] = 8; m[(8, 1)] = 4; m[(8, 2)] = 0; m[(8, 3)] = 3; m[(8, 4)] = 2; m[(8, 5)] = 7; m[(8, 6)] = 1; m[(8, 7)] = 6; m[(8, 8)] = 5;
    c[(0, 0)] = 0; c[(0, 1)] = 1; c[(0, 2)] = 1; c[(0, 3)] = 1; c[(0, 4)] = 1; c[(0, 5)] = 1; c[(0, 6)] = 1; c[(0, 7)] = 1; c[(0, 8)] = 1; c[(1, 0)] = 2; c[(1, 1)] = 3; c[(1, 2)] = 4; c[(1, 3)] = 5; c[(1, 4)] = 6; c[(1, 5)] = 7; c[(1, 6)] = 8; c[(1, 7)] = 9; c[(1, 8)] = 10; c[(2, 0)] = 2; c[(2, 1)] = 4; c[(2, 2)] = 3; c[(2, 3)] = 8; c[(2, 4)] = 10; c[(2, 5)] = 9; c[(2, 6)] = 5; c[(2, 7)] = 7; c[(2, 8)] = 6; c[(3, 0)] = 2; c[(3, 1)] = 8; c[(3, 2)] = 5; c[(3, 3)] = 3; c[(3, 4)] = 9; c[(3, 5)] = 6; c[(3, 6)] = 4; c[(3, 7)] = 10; c[(3, 8)] = 7; c[(4, 0)] = 2; c[(4, 1)] = 7; c[(4, 2)] = 9; c[(4, 3)] = 10; c[(4, 4)] = 3; c[(4, 5)] = 5; c[(4, 6)] = 6; c[(4, 7)] = 8; c[(4, 8)] = 4; c[(5, 0)] = 2; c[(5, 1)] = 6; c[(5, 2)] = 10; c[(5, 3)] = 7; c[(5, 4)] = 8; c[(5, 5)] = 3; c[(5, 6)] = 9; c[(5, 7)] = 4; c[(5, 8)] = 5; c[(6, 0)] = 2; c[(6, 1)] = 5; c[(6, 2)] = 8; c[(6, 3)] = 4; c[(6, 4)] = 7; c[(6, 5)] = 10; c[(6, 6)] = 3; c[(6, 7)] = 6; c[(6, 8)] = 9; c[(7, 0)] = 2; c[(7, 1)] = 10; c[(7, 2)] = 6; c[(7, 3)] = 9; c[(7, 4)] = 5; c[(7, 5)] = 4; c[(7, 6)] = 7; c[(7, 7)] = 3; c[(7, 8)] = 8; c[(8, 0)] = 2; c[(8, 1)] = 9; c[(8, 2)] = 7; c[(8, 3)] = 6; c[(8, 4)] = 4; c[(8, 5)] = 8; c[(8, 6)] = 10; c[(8, 7)] = 5; c[(8, 8)] = 3;
    t = [(0, 0, 0, 0, ), (1, 2, 10, 1, ), (2, 3, 1, 7, ), (3, 5, 7, 2, ), (4, 6, 4, 9, ), (5, 9, 9, 8, ), (6, 7, 2, 6, ), (7, 1, 5, 4, ), (8, 8, 8, 3, ), (9, 4, 3, 10, ), (10, 10, 6, 5, ), ]
    return n, name, m, c, t



def main(K, magmadef, WITH_CONSTS):
    F = Datatype('F')
    for i in range(K):
        F.declare('z' + str(i))
    F = F.create()

    vals = [F.constructor(i)() for i in range(K)]

    s = Solver()
    N, m_name, m_m, m_c, m_t = magmadef()

    add = Function('add', F, F, F)
    mul = Function('mul', F, F, F)

    for i, a in enumerate(vals):
        for j, b in enumerate(vals):
            s.add(add(a, b) == vals[(i + j) % K])
            s.add(mul(a, b) == vals[(i * j) % K])

    A = [Const(f'a{i}', F) for i in range(len(m_t))]
    B = [Const(f'b{i}', F) for i in range(len(m_t))]
    C = [Const(f'c{i}', F) for i in range(len(m_t))]

    def f(tr_char, x, y):
        tr = int(tr_char)

        a = mul(A[tr], x)
        b = mul(B[tr], y)
        c = C[tr]
        return add(add(a, b), c)

    def expr(t, x, y):
        # returns f(y, f(x, f(f(y, x), y)))
        layer0 = f(t[0], y, x)
        layer1 = f(t[1], layer0, y)
        layer2 = f(t[2], x, layer1)
        layer3 = f(t[3], y, layer2)
        return layer3

    for i in range(len(m_t)):
        t = m_t[i]
        s.add(expr(t, F.z0, F.z1) == F.z0)
        s.add(expr(t, F.z1, F.z0) == F.z1)
        s.add(expr(t, F.z0, F.z0) == F.z0)

        # To simplify
        if not WITH_CONSTS:
            s.add(C[i] == F.z0)

    def check_sol(As, Bs, Cs):
        p = []
        for i in range(N):
            for j in range(K):
                p.append((i, j))

        def f(x, y):
            l = m_m[(x[0], y[0])]
            i = m_c[(x[0], y[0])]
            r = (As[i]*x[1] + Bs[i]*y[1] + Cs[i])%K
            return (l, r)

        for x in p: 
            for y in p: 
                assert(x == f(y, f(x, f(f(y, x), y))))

        for x in p: 
            assert(x == f(f(f(x, x), x), x))

        for i, x in enumerate(p):
            for j, y in enumerate(p):
                k = p.index(f(x, y))
                print(k, end=" ")
            print(flush=True)

    while s.check() == sat:
        m = s.model()
        print("solution found:")
        print("K =", K)
        print("BASE =", m_name)

        def zz(x):
            v = m.eval(x, model_completion=True)
            return int(str(v)[1:])

        As = [zz(A[i]) for i in range(len(m_t))]
        Bs = [zz(B[i]) for i in range(len(m_t))]
        Cs = [zz(C[i]) for i in range(len(m_t))]
        for i in range(len(m_t)):
            print(f"A[{i}] =", As[i])
            print(f"B[{i}] =", Bs[i])
            print(f"C[{i}] =", Cs[i])
        check_sol(As, Bs, Cs)

        l = []
        for i in range(len(m_t)):
            l.append(A[i] != vals[As[i]])
            l.append(B[i] != vals[Bs[i]])
            l.append(C[i] != vals[Cs[i]])
        s.add(Or(*l))

    print("no more solutions")

for base in [magmadef_7_0, magmadef_7_1, magmadef_9_0]:
    for K in range(2, 13):
        main(K, base, False)
